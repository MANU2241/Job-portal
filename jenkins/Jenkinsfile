pipeline {
    agent any

    tools {
        nodejs 'node20'
        maven 'M3'
    }

    environment {
        DOCKER_REGISTRY = 'YOUR_USER_NAME'
        BACKEND_IMAGE   = "${DOCKER_REGISTRY}/jobportal-backend"
        FRONTEND_IMAGE  = "${DOCKER_REGISTRY}/jobportal-frontend"
        DOCKER_CREDS_ID = 'dockerhub-creds'

        KUBECTL = '"C:\\Program Files\\Docker\\Docker\\resources\\bin\\kubectl.exe"'
        K8S_NAMESPACE = 'joblisting'
    }

    triggers {
        githubPush()
        pollSCM('H/5 * * * *')
    }

    stages {

        stage('Checkout from GitHub') {
            steps {
                git branch: 'main', 
                    url: 'https://github.com/MANU2241/Job-portal.git'
            }
        }

        stage('Build Backend (Spring Boot)') {
            steps {
                dir('SpringMongoDB-main') {
                    bat "mvn clean package -DskipTests"
                }
            }
        }

        stage('Build Frontend (React)') {
            steps {
                dir('UISpringMongodb-main') {
                    bat "npm install"
                    bat "npm run build"
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    bat "docker build -t ${BACKEND_IMAGE}:${BUILD_NUMBER} -f SpringMongoDB-main/Dockerfile SpringMongoDB-main"
                    bat "docker build -t ${FRONTEND_IMAGE}:${BUILD_NUMBER} -f UISpringMongodb-main/Dockerfile UISpringMongodb-main"

                    bat "docker tag ${BACKEND_IMAGE}:${BUILD_NUMBER} ${BACKEND_IMAGE}:latest"
                    bat "docker tag ${FRONTEND_IMAGE}:${BUILD_NUMBER} ${FRONTEND_IMAGE}:latest"
                }
            }
        }

        stage('Push Docker Images') {
            steps {
                script {
                    withCredentials([usernamePassword(
                        credentialsId: DOCKER_CREDS_ID,
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        bat """
                        echo %DOCKER_PASS% | docker login -u %DOCKER_USER% --password-stdin
                        docker push ${BACKEND_IMAGE}:${BUILD_NUMBER}
                        docker push ${BACKEND_IMAGE}:latest
                        docker push ${FRONTEND_IMAGE}:${BUILD_NUMBER}
                        docker push ${FRONTEND_IMAGE}:latest
                        """
                    }
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    bat "${KUBECTL} apply -f k8s/namespace.yaml"
                    bat "${KUBECTL} apply -f k8s/backend-deployment.yaml"
                    bat "${KUBECTL} apply -f k8s/backend-service.yaml"
                    bat "${KUBECTL} apply -f k8s/frontend-deployment.yaml"
                    bat "${KUBECTL} apply -f k8s/frontend-service.yaml"
                    bat "${KUBECTL} apply -f k8s/ingress.yaml"
                }
            }
        }
    }

    post {
        success {
            echo "üöÄ Deployment Successful!"
        }
        failure {
            echo "‚ùå Pipeline Failed ‚Äî Check Logs."
        }
    }
}
